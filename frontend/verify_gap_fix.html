<!DOCTYPE html>
<html>
<head>
    <title>Verify Gap Fix</title>
</head>
<body>
    <h1>Verify Monday Gap Fix</h1>
    <button onclick="verifyFix()">Test Gap Calculation</button>
    <pre id="output"></pre>

    <script>
    // Include the updated gap calculation logic
    function parseTimeToSeconds(timeStr, templateType) {
        if (!timeStr) return 0;
        
        if (templateType === 'weekly' && timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            const dayStr = parts[0];
            const dayOffsets = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
            const dayOffset = dayOffsets[dayStr.toLowerCase()] || 0;
            
            const timeOnly = parts.slice(1).join(' ');
            let [time, period] = timeOnly.split(' ');
            let [h, m, s] = time.split(':').map(x => parseFloat(x) || 0);
            
            if (period && period.toLowerCase() === 'pm' && h !== 12) h += 12;
            if (period && period.toLowerCase() === 'am' && h === 12) h = 0;
            
            return dayOffset * 86400 + h * 3600 + m * 60 + s;
        }
        return 0;
    }

    function formatTimeFromSeconds(seconds, type) {
        if (type === 'weekly') {
            const dayNum = Math.floor(seconds / 86400);
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayName = dayNames[dayNum] || 'sun';
            
            const timeOfDay = seconds % 86400;
            const hours = Math.floor(timeOfDay / 3600);
            const minutes = Math.floor((timeOfDay % 3600) / 60);
            const secs = timeOfDay % 60;
            
            const h12 = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            const ampm = hours < 12 ? 'am' : 'pm';
            
            return `${dayName} ${h12}:${minutes.toString().padStart(2, '0')}:${secs.toFixed(3).padStart(6, '0')} ${ampm}`;
        }
        return `${Math.floor(seconds/3600)}:${Math.floor((seconds%3600)/60)}:${(seconds%60).toFixed(3)}`;
    }

    function verifyFix() {
        const output = document.getElementById('output');
        output.textContent = '';
        
        // Test schedule similar to the actual Monday
        const template = {
            type: 'weekly',
            items: [
                // Monday content before meetings
                { title: 'Content 1', start_time: 'mon 10:56:34 am', duration_seconds: 170 },
                { title: 'Content 2', start_time: 'mon 10:59:24 am', duration_seconds: 15 },
                { title: 'Content 3', start_time: 'mon 10:59:39 am', duration_seconds: 16 },
                
                // Live meetings (these will be filtered out)
                { title: 'Live Input - Committee Room 1', start_time: 'mon 11:00:00 am', duration_seconds: 7200, is_live_input: true },
                { title: 'Live Input - Committee Room 1', start_time: 'mon 1:00:00 pm', duration_seconds: 10800, is_live_input: true },
                
                // Some Tuesday content
                { title: 'Tuesday Content', start_time: 'tue 12:00:00 am', duration_seconds: 300 }
            ]
        };
        
        // Filter out live inputs
        const sortedItems = template.items
            .filter(item => !item.is_live_input)
            .sort((a, b) => {
                const aSeconds = parseTimeToSeconds(a.start_time, template.type);
                const bSeconds = parseTimeToSeconds(b.start_time, template.type);
                return aSeconds - bSeconds;
            });
        
        output.textContent += 'Filtered items (non-live inputs):\n';
        sortedItems.forEach(item => {
            const start = parseTimeToSeconds(item.start_time, template.type);
            const end = start + item.duration_seconds;
            output.textContent += `- ${item.title}: ${start/3600}h to ${end/3600}h\n`;
        });
        
        // Calculate gaps using per-day logic
        const gaps = [];
        
        // Group items by day
        const itemsByDay = {};
        for (let day = 0; day < 7; day++) {
            itemsByDay[day] = [];
        }
        
        sortedItems.forEach(item => {
            const start = parseTimeToSeconds(item.start_time, template.type);
            const dayNum = Math.floor(start / 86400);
            if (dayNum >= 0 && dayNum < 7) {
                itemsByDay[dayNum].push(item);
            }
        });
        
        output.textContent += '\nItems by day:\n';
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        for (let day = 0; day < 7; day++) {
            if (itemsByDay[day].length > 0) {
                output.textContent += `${dayNames[day]}: ${itemsByDay[day].length} items\n`;
            }
        }
        
        // Check for gaps at the end of each day
        for (let day = 0; day < 7; day++) {
            const dayStart = day * 86400;
            const dayEnd = (day + 1) * 86400;
            const dayItems = itemsByDay[day];
            
            if (dayItems.length > 0) {
                // Check if the last item on this day ends before midnight
                const lastDayItem = dayItems[dayItems.length - 1];
                const itemStart = parseTimeToSeconds(lastDayItem.start_time, template.type);
                const itemEnd = itemStart + lastDayItem.duration_seconds;
                
                if (itemEnd < dayEnd) {
                    gaps.push({
                        startTime: formatTimeFromSeconds(itemEnd, template.type),
                        endTime: formatTimeFromSeconds(dayEnd - 0.001, template.type),
                        startSeconds: itemEnd,
                        endSeconds: dayEnd,
                        duration: dayEnd - itemEnd
                    });
                    output.textContent += `\n${dayNames[day]} gap: from ${itemEnd/3600}h to ${dayEnd/3600}h (${(dayEnd-itemEnd)/3600} hours)\n`;
                }
            }
        }
        
        output.textContent += `\nTotal gaps calculated: ${gaps.length}\n`;
        output.textContent += '\nGaps detail:\n';
        gaps.forEach((gap, idx) => {
            output.textContent += `Gap ${idx+1}: ${gap.startSeconds/3600}h to ${gap.endSeconds/3600}h\n`;
            output.textContent += `  Start: ${gap.startTime}\n`;
            output.textContent += `  End: ${gap.endTime}\n`;
            output.textContent += `  Duration: ${gap.duration/3600} hours\n\n`;
        });
        
        output.textContent += '\nExpected result:\n';
        output.textContent += 'Monday gap should be from ~39595 seconds (10:59:55 AM) to 172800 seconds (Tuesday midnight)\n';
        output.textContent += 'This is approximately 37 hours, which is correct for Monday afternoon through midnight.\n';
    }
    </script>
</body>
</html></content>
</invoke>